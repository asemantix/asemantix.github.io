
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMELEON ASEMANTIX ‚Äî Communication Invisible</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 20px 0; }
        .logo { font-size: 40px; margin-bottom: 5px; }
        .title { font-size: 24px; font-weight: 700; color: #00d9ff; letter-spacing: 3px; }
        .subtitle { font-size: 12px; color: #888; margin-top: 5px; }
        .badge { 
            display: inline-block; background: rgba(0,255,136,0.2); color: #00ff88; 
            padding: 4px 12px; border-radius: 20px; font-size: 10px; margin-top: 8px;
            border: 1px solid rgba(0,255,136,0.3);
        }
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 16px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 20px;
        }
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .status-badge.disconnected { background: rgba(255,77,77,0.2); color: #ff4d4d; }
        .status-badge.connected { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .member-id { font-size: 12px; color: #00d9ff; font-weight: 600; }
        .card {
            background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px;
            margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 12px; text-transform: uppercase; letter-spacing: 2px;
            color: #00d9ff; margin-bottom: 16px;
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab {
            flex: 1; padding: 12px 8px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
            color: #888; cursor: pointer; text-align: center; font-size: 12px;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: rgba(0,217,255,0.1); border-color: #00d9ff; color: #00d9ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-upload {
            border: 2px dashed rgba(0,217,255,0.3); border-radius: 12px; padding: 30px;
            text-align: center; cursor: pointer;
        }
        .file-upload:hover { border-color: #00d9ff; background: rgba(0,217,255,0.05); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 40px; margin-bottom: 10px; }
        .qr-divider {
            display: flex; align-items: center; margin: 20px 0; color: #666; font-size: 12px;
        }
        .qr-divider::before, .qr-divider::after {
            content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1);
        }
        .qr-divider span { padding: 0 15px; }
        .qr-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000;
            border: none; padding: 14px 24px; border-radius: 10px; font-size: 14px;
            font-weight: 600; cursor: pointer;
        }
        .vocab-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .vocab-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 12px 10px; color: #e4e4e4; font-size: 12px;
            cursor: pointer; text-align: center;
        }
        .vocab-btn:hover { background: rgba(0,217,255,0.1); border-color: #00d9ff; }
        .vocab-btn.selected { background: rgba(0,217,255,0.2); border-color: #00d9ff; color: #00d9ff; }
        .vocab-btn .position { font-size: 9px; color: #666; display: block; margin-bottom: 2px; }
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 14px;
            font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-top: 12px;
        }
        .btn-primary { background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); color: #000; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-success { background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e4e4e4; border: 1px solid rgba(255,255,255,0.2); }
        .fragment-box {
            background: #0a0a0a; border-radius: 10px; padding: 14px;
            font-family: 'Courier New', monospace; font-size: 9px; word-break: break-all;
            color: #00ff88; margin: 12px 0; position: relative; border: 1px solid rgba(0,255,136,0.3);
            line-height: 1.4;
        }
        .fragment-info {
            font-size: 10px; color: #666; margin-top: 8px; text-align: center;
        }
        .copy-btn {
            position: absolute; top: 8px; right: 8px; background: rgba(0,255,136,0.2);
            border: none; padding: 4px 10px; border-radius: 6px; color: #00ff88; cursor: pointer; font-size: 10px;
        }
        .input-group { margin: 12px 0; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 6px; text-transform: uppercase; }
        .input-group textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 12px 14px; color: #e4e4e4; font-size: 11px;
            min-height: 80px; font-family: 'Courier New', monospace;
        }
        .input-group textarea:focus { outline: none; border-color: #00d9ff; }
        .result-message {
            background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,217,255,0.1) 100%);
            border: 1px solid rgba(0,255,136,0.3); border-radius: 12px; padding: 16px;
            text-align: center; margin: 12px 0;
        }
        .result-message .label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .result-message .sender { font-size: 14px; color: #00d9ff; font-weight: 600; margin-bottom: 4px; }
        .result-message .message { font-size: 22px; font-weight: 700; color: #00ff88; }
        .result-message.error { background: rgba(255,77,77,0.1); border-color: rgba(255,77,77,0.3); }
        .result-message.error .message { color: #ff4d4d; font-size: 14px; }
        .stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;
        }
        .stat {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; text-align: center;
        }
        .stat-value { font-size: 18px; font-weight: 700; color: #00d9ff; }
        .stat-label { font-size: 9px; color: #666; text-transform: uppercase; margin-top: 4px; }
        .footer { text-align: center; padding: 20px; color: #444; font-size: 11px; }
        .hidden { display: none !important; }
        .qr-scanner-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #000; z-index: 2000; display: none; flex-direction: column;
        }
        .qr-scanner-container.active { display: flex; }
        .qr-scanner-header { padding: 20px; text-align: center; background: rgba(0,0,0,0.8); }
        .qr-scanner-header h2 { color: #00d9ff; font-size: 18px; margin-bottom: 8px; }
        .qr-scanner-header p { color: #888; font-size: 12px; }
        .qr-video-container { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .qr-video-container video { width: 100%; height: 100%; object-fit: cover; }
        .qr-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 250px; border: 3px solid #00d9ff; border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .qr-scanner-footer { padding: 20px; text-align: center; background: rgba(0,0,0,0.8); }
        .qr-cancel-btn {
            background: rgba(255,77,77,0.2); color: #ff4d4d;
            border: 1px solid rgba(255,77,77,0.3); padding: 12px 30px; border-radius: 10px; font-size: 14px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="qr-scanner-container" id="qr-scanner">
        <div class="qr-scanner-header">
            <h2>üì∑ Scanner le QR Code</h2>
            <p>Placez le QR code dans le cadre</p>
        </div>
        <div class="qr-video-container">
            <video id="qr-video" playsinline></video>
            <div class="qr-overlay"></div>
        </div>
        <div class="qr-scanner-footer">
            <button class="qr-cancel-btn" onclick="stopQRScanner()">‚úï Annuler</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">ü¶é</div>
            <div class="title">Cameleon</div>
            <div class="subtitle">Communication Invisible par AION</div>
            <div class="badge">üõ°Ô∏è ASEMANTIX ‚Äî Marqueurs Polymorphes</div>
        </div>

        <div class="status-bar">
            <span id="status-badge" class="status-badge disconnected">
                <span class="status-dot"></span>
                <span id="status-text">Non connect√©</span>
            </span>
            <span class="member-id" id="my-member-id"></span>
        </div>

        <div id="upload-section">
            <div class="card">
                <div class="card-title">üìÅ Charger votre graine</div>
                <div class="file-upload" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".cameleon,.json" onchange="handleFileUpload(event)">
                    <div class="file-upload-icon">üîê</div>
                    <div style="color: #888; font-size: 13px;">Cliquez pour charger votre fichier</div>
                </div>
                <div class="qr-divider"><span>OU</span></div>
                <div style="text-align: center;">
                    <button class="qr-btn" onclick="startQRScanner()">üì∑ Scanner un QR Code</button>
                </div>
            </div>
        </div>

        <div id="main-interface" class="hidden">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('send')">üì§ Envoyer</div>
                <div class="tab" onclick="switchTab('receive')">üì• Recevoir</div>
                <div class="tab" onclick="switchTab('stats')">üìä Stats</div>
            </div>

            <div id="tab-send" class="tab-content active">
                <div class="card">
                    <div class="card-title">Choisir un message</div>
                    <div class="vocab-grid" id="vocab-grid"></div>
                </div>
                <button class="btn btn-primary" id="send-btn" onclick="sendMessage()" disabled>üîí G√©n√©rer fragment ASEMANTIX</button>
                <div id="send-result" class="hidden">
                    <div class="fragment-box">
                        <button class="copy-btn" onclick="copyFragment()">üìã Copier</button>
                        <div id="fragment-output"></div>
                    </div>
                    <div class="fragment-info">
                        256 bits ‚Ä¢ Marqueur polymorphe ‚Ä¢ Indistinguable du bruit
                    </div>
                </div>
            </div>

            <div id="tab-receive" class="tab-content">
                <div class="card">
                    <div class="card-title">D√©coder un fragment</div>
                    <div class="input-group">
                        <label>Collez le fragment re√ßu (256 bits hex)</label>
                        <textarea id="receive-input" placeholder="Collez ici le fragment de 64 caract√®res hex..."></textarea>
                    </div>
                </div>
                <button class="btn btn-success" onclick="receiveMessage()">üîì Filtrer & D√©coder</button>
                <div id="receive-result" class="hidden"></div>
            </div>

            <div id="tab-stats" class="tab-content">
                <div class="card">
                    <div class="card-title">üìä Statistiques ASEMANTIX</div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="stat-sent">0</div>
                            <div class="stat-label">Envoy√©s</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="stat-received">0</div>
                            <div class="stat-label">Re√ßus</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="stat-rejected">0</div>
                            <div class="stat-label">Rejet√©s</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 8px;">PARAM√àTRES POLYMORPHES</div>
                        <div style="font-size: 12px; color: #00d9ff;">
                            ‚Ä¢ Fragment : 256 bits<br>
                            ‚Ä¢ Marqueur : <span id="marker-k">16</span> positions<br>
                            ‚Ä¢ Filtrage rapide : ~99% rejet bruit<br>
                            ‚Ä¢ Index actuel : <span id="current-index">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="logout()">Se d√©connecter</button>
            </div>
        </div>

        <div class="footer">
            <p>üõ°Ô∏è ASEMANTIX ‚Äî Aucune m√©tadonn√©e</p>
            <p>¬© 2026 AION ‚Äî Brevet d√©pos√©</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ASEMANTIX CAMELEON ‚Äî VRAI SYST√àME BREVET√â
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 
        // Fragment F de 256 bits (32 octets)
        // Marqueur polymorphe M(j) : k positions avec valeurs d√©riv√©es de K + j
        // Indistinguable du bruit al√©atoire
        // Filtrage rapide sans calcul cryptographique
        // Anti-rejeu par ancre monotone
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const ASEMANTIX = {
            FRAGMENT_BITS: 256,
            FRAGMENT_BYTES: 32,
            MARKER_POSITIONS: 16,  // k = 16 positions de marqueur
            MARKER_BITS_PER_POS: 1 // 1 bit par position
        };

        let state = {
            loaded: false,
            config: null,
            graine: null,
            vocabulaire: {},
            myMemberId: null,
            selectedMessage: null,
            messageIndex: 0,
            stats: { sent: 0, received: 0, rejected: 0 }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRYPTO PRIMITIVES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function sha256(data) {
            const encoder = new TextEncoder();
            const dataBuffer = typeof data === 'string' ? encoder.encode(data) : data;
            return new Uint8Array(await crypto.subtle.digest('SHA-256', dataBuffer));
        }

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARQUEUR POLYMORPHE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //
        // Le marqueur M(j) d√©finit k positions de bits et leurs valeurs
        // d√©riv√©es de fa√ßon d√©terministe de K (graine) et j (index)
        // La configuration change INT√âGRALEMENT √† chaque index
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function deriveMarkerPositions(graine, index, k) {
            // D√©river k positions uniques dans le fragment de 256 bits
            const seed = await sha256(graine + ':marker:positions:' + index);
            const positions = [];
            let i = 0;
            
            while (positions.length < k && i < 32) {
                const pos = seed[i] % ASEMANTIX.FRAGMENT_BITS;
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
                i++;
            }
            
            // Si pas assez de positions uniques, g√©n√©rer plus
            while (positions.length < k) {
                const extraSeed = await sha256(graine + ':marker:extra:' + index + ':' + positions.length);
                const pos = extraSeed[0] % ASEMANTIX.FRAGMENT_BITS;
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
            }
            
            return positions.sort((a, b) => a - b);
        }

        async function deriveMarkerValues(graine, index, k) {
            // D√©river k valeurs de bits (0 ou 1) pour les positions
            const seed = await sha256(graine + ':marker:values:' + index);
            const values = [];
            
            for (let i = 0; i < k; i++) {
                const byteIndex = Math.floor(i / 8);
                const bitIndex = i % 8;
                const bit = (seed[byteIndex] >> bitIndex) & 1;
                values.push(bit);
            }
            
            return values;
        }

        function getBit(bytes, bitPos) {
            const byteIndex = Math.floor(bitPos / 8);
            const bitIndex = bitPos % 8;
            return (bytes[byteIndex] >> (7 - bitIndex)) & 1;
        }

        function setBit(bytes, bitPos, value) {
            const byteIndex = Math.floor(bitPos / 8);
            const bitIndex = bitPos % 8;
            if (value) {
                bytes[byteIndex] |= (1 << (7 - bitIndex));
            } else {
                bytes[byteIndex] &= ~(1 << (7 - bitIndex));
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // G√âN√âRATION DE FRAGMENT ASEMANTIX
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //
        // 1. G√©n√©rer 256 bits pseudo-al√©atoires (payload chiffr√©)
        // 2. Encoder le message dans le payload
        // 3. Forcer le marqueur polymorphe aux positions d√©riv√©es
        // 4. R√©sultat : indistinguable du bruit
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function generateAsemantixFragment(graine, position, index, senderId) {
            const k = ASEMANTIX.MARKER_POSITIONS;
            
            // 1. D√©river les positions et valeurs du marqueur pour cet index
            const markerPositions = await deriveMarkerPositions(graine, index, k);
            const markerValues = await deriveMarkerValues(graine, index, k);
            
            // 2. G√©n√©rer le payload pseudo-al√©atoire bas√© sur graine + index
            const payloadSeed = await sha256(graine + ':payload:' + index);
            const fragment = new Uint8Array(ASEMANTIX.FRAGMENT_BYTES);
            
            // Remplir avec des donn√©es pseudo-al√©atoires
            for (let i = 0; i < ASEMANTIX.FRAGMENT_BYTES; i++) {
                fragment[i] = payloadSeed[i % payloadSeed.length] ^ 
                              ((index * 17 + i * 31) & 0xFF);
            }
            
            // 3. Encoder le message (position dans vocabulaire) et senderId
            // On utilise les premiers octets non-marqueur pour encoder les donn√©es
            const dataSeed = await sha256(graine + ':data:' + index + ':' + position + ':' + senderId);
            
            // XOR avec les donn√©es encod√©es (position + senderId cach√©s dans le bruit)
            fragment[0] ^= (position & 0xFF);
            fragment[1] ^= (senderId & 0xFF);
            fragment[2] ^= dataSeed[0];
            fragment[3] ^= dataSeed[1];
            
            // 4. FORCER le marqueur polymorphe aux positions d√©riv√©es
            for (let i = 0; i < k; i++) {
                setBit(fragment, markerPositions[i], markerValues[i]);
            }
            
            return bytesToHex(fragment);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILTRAGE RAPIDE (REJET 99% DU BRUIT)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //
        // Le r√©cepteur v√©rifie UNIQUEMENT les bits du marqueur
        // SANS calcul cryptographique lourd
        // Si le marqueur ne correspond pas ‚Üí rejet imm√©diat
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function fastFilter(graine, fragmentHex, index) {
            if (fragmentHex.length !== 64) return false; // 256 bits = 64 hex
            
            const fragment = hexToBytes(fragmentHex);
            const k = ASEMANTIX.MARKER_POSITIONS;
            
            // D√©river le marqueur attendu pour cet index
            const markerPositions = await deriveMarkerPositions(graine, index, k);
            const markerValues = await deriveMarkerValues(graine, index, k);
            
            // V√©rifier TOUS les bits du marqueur
            for (let i = 0; i < k; i++) {
                const actualBit = getBit(fragment, markerPositions[i]);
                if (actualBit !== markerValues[i]) {
                    return false; // Rejet rapide !
                }
            }
            
            return true; // Marqueur valide ‚Üí candidat pour d√©codage complet
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // D√âCODAGE COMPLET (APR√àS FILTRAGE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function decodeAsemantixFragment(graine, fragmentHex, vocabulaire, startIndex) {
            const fragment = hexToBytes(fragmentHex);
            
            // Chercher dans une fen√™tre d'index (anti-rejeu avec tol√©rance)
            const windowSize = 100;
            
            for (let index = startIndex; index < startIndex + windowSize; index++) {
                // Filtrage rapide
                if (!await fastFilter(graine, fragmentHex, index)) {
                    state.stats.rejected++;
                    continue;
                }
                
                // Marqueur valide ! Tenter le d√©codage complet
                const dataSeed = await sha256(graine + ':data:' + index + ':');
                
                // Essayer chaque message du vocabulaire
                for (const [pos, msg] of Object.entries(vocabulaire)) {
                    for (let senderId = 1; senderId <= 20; senderId++) {
                        const testFragment = await generateAsemantixFragment(
                            graine, parseInt(pos), index, senderId
                        );
                        
                        if (testFragment === fragmentHex) {
                            return {
                                success: true,
                                message: msg,
                                senderId: senderId,
                                index: index
                            };
                        }
                    }
                }
            }
            
            return { success: false, error: 'Fragment non reconnu' };
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTERFACE & FICHIERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { processConfig(JSON.parse(e.target.result)); }
                catch (error) { alert('Fichier invalide'); }
            };
            reader.readAsText(file);
        }

        function processConfig(config) {
            const graine = config.graine_K0 || config.g;
            const vocabulaire = config.vocabulaire?.messages || config.vocabulaire || config.voc;
            if (!graine || !vocabulaire) { alert('Fichier incomplet'); return; }
            
            const memberId = prompt('Entrez votre num√©ro de membre (1, 2, 3...)');
            if (!memberId) return;
            
            state.config = config;
            state.graine = graine;
            state.vocabulaire = vocabulaire;
            state.myMemberId = parseInt(memberId);
            state.loaded = true;
            
            const pairId = config.paire_id || config.p || 'default';
            const savedIndex = localStorage.getItem('asemantix_index_' + pairId);
            state.messageIndex = savedIndex ? parseInt(savedIndex) : 0;
            
            updateUI();
        }

        // QR Scanner
        let qrScanner = { stream: null, scanning: false };
        
        async function startQRScanner() {
            try {
                qrScanner.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('qr-video');
                video.srcObject = qrScanner.stream;
                await video.play();
                document.getElementById('qr-scanner').classList.add('active');
                qrScanner.scanning = true;
                scanQRCode();
            } catch (error) { alert('Impossible d\'acc√©der √† la cam√©ra'); }
        }

        function stopQRScanner() {
            qrScanner.scanning = false;
            if (qrScanner.stream) qrScanner.stream.getTracks().forEach(track => track.stop());
            document.getElementById('qr-scanner').classList.remove('active');
        }

        function scanQRCode() {
            if (!qrScanner.scanning) return;
            const video = document.getElementById('qr-video');
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) { handleQRCode(code.data); return; }
                }
            }
            requestAnimationFrame(scanQRCode);
        }

        function handleQRCode(data) {
            stopQRScanner();
            try {
                let config;
                if (data.startsWith('AION:')) {
                    config = JSON.parse(decodeURIComponent(escape(atob(data.substring(5)))));
                } else {
                    config = JSON.parse(data);
                }
                processConfig(config);
                if (navigator.vibrate) navigator.vibrate(200);
            } catch (error) { alert('QR Code invalide'); }
        }

        // UI Updates
        function updateUI() {
            document.getElementById('status-badge').className = 'status-badge connected';
            document.getElementById('status-text').textContent = 'Connect√©';
            document.getElementById('my-member-id').textContent = '#' + state.myMemberId;
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('current-index').textContent = state.messageIndex;
            
            const grid = document.getElementById('vocab-grid');
            grid.innerHTML = '';
            for (const [pos, msg] of Object.entries(state.vocabulaire)) {
                const btn = document.createElement('button');
                btn.className = 'vocab-btn';
                btn.innerHTML = `<span class="position">#${pos}</span>${msg}`;
                btn.onclick = () => {
                    document.querySelectorAll('.vocab-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.selectedMessage = { position: parseInt(pos), message: msg };
                    document.getElementById('send-btn').disabled = false;
                };
                grid.appendChild(btn);
            }
            
            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-sent').textContent = state.stats.sent;
            document.getElementById('stat-received').textContent = state.stats.received;
            document.getElementById('stat-rejected').textContent = state.stats.rejected;
            document.getElementById('current-index').textContent = state.messageIndex;
        }

        // Send Message
        async function sendMessage() {
            if (!state.selectedMessage || !state.loaded) return;
            
            state.messageIndex++;
            const pairId = state.config.paire_id || state.config.p || 'default';
            localStorage.setItem('asemantix_index_' + pairId, state.messageIndex.toString());
            
            const fragment = await generateAsemantixFragment(
                state.graine,
                state.selectedMessage.position,
                state.messageIndex,
                state.myMemberId
            );
            
            document.getElementById('fragment-output').textContent = fragment;
            document.getElementById('send-result').classList.remove('hidden');
            
            state.stats.sent++;
            updateStats();
            
            document.querySelectorAll('.vocab-btn').forEach(b => b.classList.remove('selected'));
            state.selectedMessage = null;
            document.getElementById('send-btn').disabled = true;
        }

        // Receive Message
        async function receiveMessage() {
            if (!state.loaded) return;
            
            const input = document.getElementById('receive-input').value.trim().toLowerCase();
            if (!input) { alert('Collez un fragment √† d√©coder'); return; }
            if (input.length !== 64) { alert('Le fragment doit faire 64 caract√®res hex (256 bits)'); return; }
            
            const resultDiv = document.getElementById('receive-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="result-message"><div class="message">‚è≥ Filtrage en cours...</div></div>';
            
            // Petit d√©lai pour afficher le loading
            await new Promise(r => setTimeout(r, 100));
            
            const result = await decodeAsemantixFragment(
                state.graine,
                input,
                state.vocabulaire,
                Math.max(0, state.messageIndex - 50)
            );
            
            if (result.success) {
                state.stats.received++;
                resultDiv.innerHTML = `
                    <div class="result-message">
                        <div class="label">Message de</div>
                        <div class="sender">#${result.senderId}</div>
                        <div class="message">${result.message}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 8px;">Index: ${result.index}</div>
                    </div>
                `;
                document.getElementById('receive-input').value = '';
            } else {
                resultDiv.innerHTML = `
                    <div class="result-message error">
                        <div class="label">Filtrage</div>
                        <div class="message">${result.error}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 8px;">
                            ${state.stats.rejected} fragments rejet√©s par filtrage rapide
                        </div>
                    </div>
                `;
            }
            
            updateStats();
        }

        function copyFragment() {
            navigator.clipboard.writeText(document.getElementById('fragment-output').textContent).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '‚úì Copi√© !';
                setTimeout(() => btn.textContent = 'üìã Copier', 2000);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('send-result').classList.add('hidden');
            document.getElementById('receive-result').classList.add('hidden');
        }

        function logout() {
            if (confirm('Voulez-vous vous d√©connecter ?')) {
                state = {
                    loaded: false, config: null, graine: null, vocabulaire: {},
                    myMemberId: null, selectedMessage: null, messageIndex: 0,
                    stats: { sent: 0, received: 0, rejected: 0 }
                };
                document.getElementById('upload-section').classList.remove('hidden');
                document.getElementById('main-interface').classList.add('hidden');
                document.getElementById('status-badge').className = 'status-badge disconnected';
                document.getElementById('status-text').textContent = 'Non connect√©';
                document.getElementById('my-member-id').textContent = '';
            }
        }

        console.log('ü¶é CAMELEON ASEMANTIX ‚Äî Marqueurs Polymorphes ‚Äî Brevet AION');
    </script>
</body>
</html>
