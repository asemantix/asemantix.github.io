
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCTOPUS | Messagerie R√©siliente</title>
    <meta name="description" content="OCTOPUS - Un cercle. Pas un r√©seau. Messagerie r√©siliente pour cercles de confiance.">
    <meta name="theme-color" content="#0a0a12">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --void: #0a0a12;
            --void-light: #12121f;
            --void-lighter: #1a1a2e;
            --purple-deep: #2d1b4e;
            --purple: #8a2be2;
            --purple-light: #a855f7;
            --purple-glow: rgba(138, 43, 226, 0.4);
            --violet: #bf5fff;
            --white: #f0f0f5;
            --white-dim: #a0a0b0;
            --gray: #6a6a7a;
            --gold: #c9a962;
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
            --orange: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--void);
            color: var(--white);
            font-size: 16px;
            line-height: 1.5;
        }

        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Ink background */
        .ink-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .ink-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: drift 20s ease-in-out infinite;
        }

        .ink-blob-1 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, var(--purple-deep) 0%, transparent 70%);
            top: -100px; right: -100px;
        }

        .ink-blob-2 {
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.3) 0%, transparent 70%);
            bottom: 20%; left: -50px;
            animation-delay: -7s;
        }

        .ink-blob-3 {
            width: 250px; height: 250px;
            background: radial-gradient(circle, rgba(45, 27, 78, 0.5) 0%, transparent 70%);
            top: 40%; right: -30px;
            animation-delay: -14s;
        }

        @keyframes drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(20px, -20px) scale(1.05); }
            50% { transform: translate(-10px, 10px) scale(0.95); }
            75% { transform: translate(-20px, -10px) scale(1.02); }
        }

        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .screen.active { display: flex; }

        /* ==================== WELCOME SCREEN ==================== */
        .welcome-screen {
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
        }

        .welcome-logo {
            width: 180px;
            height: 180px;
            margin-bottom: 2rem;
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { filter: drop-shadow(0 0 20px var(--purple-glow)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 40px var(--purple-glow)); transform: scale(1.02); }
        }

        .welcome-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: 0.2em;
            color: var(--white);
            margin-bottom: 0.5rem;
        }

        .welcome-tagline {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--purple-light);
            letter-spacing: 0.15em;
            margin-bottom: 3rem;
        }

        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 320px;
        }

        .btn {
            padding: 1rem 2rem;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--purple) 0%, #6b21a8 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--purple-glow);
        }

        .btn-secondary {
            background: var(--void-lighter);
            color: var(--white);
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .btn-secondary:hover {
            border-color: var(--purple);
            background: var(--purple-deep);
        }

        .btn-icon { font-size: 1.2rem; }

        .welcome-note {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: var(--gray);
            max-width: 280px;
        }

        .welcome-note a {
            color: var(--purple-light);
            text-decoration: none;
        }

        /* ==================== LOAD SCREEN ==================== */
        .load-screen {
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .load-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-back {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background: none;
            border: none;
            color: var(--white-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .load-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .load-subtitle {
            color: var(--white-dim);
            font-size: 0.95rem;
            margin-bottom: 2rem;
        }

        .load-dropzone {
            border: 2px dashed rgba(138, 43, 226, 0.4);
            border-radius: 16px;
            padding: 3rem 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .load-dropzone:hover {
            border-color: var(--purple);
            background: rgba(138, 43, 226, 0.05);
        }
        
        .load-dropzone.drag-over {
            border-color: var(--purple-light);
            background: rgba(138, 43, 226, 0.15);
            transform: scale(1.02);
        }

        .load-dropzone-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .load-dropzone-text {
            color: var(--white-dim);
            font-size: 0.95rem;
        }

        .load-dropzone-hint {
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .load-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .load-divider::before,
        .load-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(138, 43, 226, 0.2);
        }

        /* ==================== PIN SCREEN (DEMO) ==================== */
        .pin-screen {
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
        }

        .pin-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 1.5rem;
            animation: breathe 4s ease-in-out infinite;
        }

        .pin-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .pin-subtitle {
            color: var(--white-dim);
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .pin-input-container {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .pin-digit {
            width: 55px;
            height: 65px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            text-align: center;
            background: var(--void-lighter);
            border: 2px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .pin-digit:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }

        .pin-hint {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .demo-badge {
            display: inline-block;
            background: rgba(201, 169, 98, 0.15);
            border: 1px solid rgba(201, 169, 98, 0.3);
            color: var(--gold);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        /* Character selection grid */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
            max-width: 400px;
        }
        
        .character-grid > :nth-child(4),
        .character-grid > :nth-child(5) {
            justify-self: center;
        }
        
        @media (max-width: 400px) {
            .character-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .character-grid > :nth-child(5) {
                grid-column: span 2;
                justify-self: center;
                max-width: 50%;
            }
        }
        
        .character-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--void-light);
            border: 2px solid rgba(138, 43, 226, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .character-btn:hover {
            border-color: var(--purple);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.3);
        }
        
        .character-btn:active {
            transform: translateY(-2px);
        }
        
        .character-avatar {
            font-size: 2.5rem;
        }
        
        .character-name {
            font-weight: 500;
            color: var(--white);
            font-size: 0.95rem;
        }
        
        .character-number {
            font-size: 0.75rem;
            color: var(--purple-light);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ==================== MAIN APP SCREEN ==================== */
        .main-screen { flex-direction: column; }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: rgba(10, 10, 18, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(138, 43, 226, 0.1);
            position: relative;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .circle-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--purple) 0%, var(--purple-deep) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .circle-avatar svg {
            width: 36px;
            height: 36px;
        }

        .circle-info h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .circle-members {
            font-size: 0.8rem;
            color: var(--white-dim);
        }

        .my-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--purple-light);
            font-size: 0.75rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--white-dim);
            font-size: 1.3rem;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            color: var(--white);
            background: var(--void-lighter);
        }

        /* Channel Bar */
        .channel-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.6rem 1.5rem;
            background: var(--void-light);
            border-bottom: 1px solid rgba(138, 43, 226, 0.1);
            overflow-x: auto;
        }

        .channel-bar::-webkit-scrollbar { display: none; }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--gray);
            white-space: nowrap;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            background: var(--void);
        }

        .channel-item.active {
            color: var(--green);
            background: rgba(16, 185, 129, 0.1);
        }

        .channel-item.available {
            color: var(--orange);
            background: rgba(245, 158, 11, 0.1);
        }

        .channel-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .channel-item.active .channel-dot {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Messages */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .messages-area::-webkit-scrollbar { width: 4px; }
        .messages-area::-webkit-scrollbar-track { background: transparent; }
        .messages-area::-webkit-scrollbar-thumb { background: var(--purple-deep); border-radius: 2px; }

        .date-separator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(138, 43, 226, 0.2), transparent);
        }

        .date-separator span {
            font-size: 0.75rem;
            color: var(--gray);
            letter-spacing: 0.1em;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 85%;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--purple-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--purple-light);
            flex-shrink: 0;
        }

        .message.sent .message-avatar {
            background: linear-gradient(135deg, var(--purple) 0%, #6b21a8 100%);
            color: var(--white);
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .message.sent .message-content {
            align-items: flex-end;
        }

        .message-sender {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--purple-light);
            font-weight: 500;
        }

        .message.sent .message-sender { display: none; }

        .message-bubble {
            background: var(--void-lighter);
            border: 1px solid rgba(138, 43, 226, 0.15);
            border-radius: 16px;
            border-top-left-radius: 4px;
            padding: 0.75rem 1rem;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--purple-deep) 0%, rgba(107, 33, 168, 0.5) 100%);
            border-color: rgba(138, 43, 226, 0.3);
            border-radius: 16px;
            border-top-right-radius: 4px;
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .message-status { color: var(--green); }

        .message-channel {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            background: var(--void);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        /* Composer */
        .composer {
            padding: 0.75rem 1rem 1.5rem;
            background: rgba(10, 10, 18, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(138, 43, 226, 0.1);
        }

        /* Recipient Selector */
        .recipient-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 0.5rem 0.75rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .recipient-label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .recipient-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            overflow-x: auto;
        }

        .recipient-selector::-webkit-scrollbar { display: none; }

        .recipient-chip {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: var(--void-lighter);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--white-dim);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .recipient-chip:hover {
            border-color: var(--purple);
            color: var(--white);
        }

        .recipient-chip.selected {
            background: linear-gradient(135deg, var(--purple-deep) 0%, rgba(107, 33, 168, 0.6) 100%);
            border-color: var(--purple);
            color: var(--white);
        }

        .recipient-chip.all {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--green);
        }

        .recipient-chip.all.selected {
            background: rgba(16, 185, 129, 0.25);
            border-color: var(--green);
        }

        .recipient-chip .chip-icon {
            font-size: 0.9rem;
        }

        .recipient-chip .chip-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            background: rgba(0,0,0,0.3);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
        }

        /* Message priv√© indicator */
        .message.private .message-bubble {
            border-left: 3px solid var(--purple);
        }

        .message.private .private-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            color: var(--purple-light);
            background: rgba(138, 43, 226, 0.15);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .composer-container {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .composer-actions { display: flex; gap: 0.25rem; }

        .composer-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.3rem;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .composer-btn:hover {
            color: var(--purple-light);
            background: var(--void-lighter);
        }

        .composer-input-wrapper { flex: 1; }

        .composer-input {
            width: 100%;
            padding: 0.85rem 1rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            background: var(--void-lighter);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 24px;
            color: var(--white);
            resize: none;
            max-height: 120px;
        }

        .composer-input:focus {
            outline: none;
            border-color: var(--purple);
        }

        .composer-input::placeholder { color: var(--gray); }

        .composer-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--purple) 0%, #6b21a8 100%);
            border: none;
            color: var(--white);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .composer-send:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px var(--purple-glow);
        }

        /* ==================== PANELS ==================== */
        .panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 360px;
            height: 100%;
            background: var(--void);
            z-index: 100;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .panel.open { right: 0; }

        .panel-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(138, 43, 226, 0.1);
        }

        .panel-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
        }

        .panel-close {
            background: none;
            border: none;
            color: var(--white-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Search */
        .search-container {
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            background: var(--void-lighter);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 12px;
            color: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--purple);
        }

        .search-input::placeholder { color: var(--gray); }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: var(--gray);
        }

        /* Members */
        .member-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 12px;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .member-item:hover {
            background: var(--void-lighter);
        }

        .member-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--purple-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--purple-light);
            position: relative;
        }

        .member-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: var(--green);
            border-radius: 50%;
            border: 2px solid var(--void);
        }

        .member-avatar.me {
            background: linear-gradient(135deg, var(--purple) 0%, #6b21a8 100%);
            color: var(--white);
        }

        .member-info { flex: 1; }

        .member-number {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--white);
        }

        .member-number span {
            font-weight: 400;
            color: var(--gray);
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        .member-status {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .call-btn {
            background: var(--purple-deep);
            border: none;
            color: var(--purple-light);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .call-btn:hover {
            background: var(--purple);
            color: var(--white);
        }

        /* Settings */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-size: 0.75rem;
            color: var(--gray);
            letter-spacing: 0.15em;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--void-lighter);
            border-radius: 12px;
            margin-bottom: 0.5rem;
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .settings-icon { font-size: 1.3rem; opacity: 0.8; }
        .settings-label { font-size: 0.95rem; }
        .settings-value { font-size: 0.85rem; color: var(--gray); }

        .toggle {
            width: 48px;
            height: 26px;
            background: var(--void);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle.active { background: var(--purple); }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active::after { transform: translateX(22px); }

        /* Circle Card */
        .circle-card {
            background: linear-gradient(135deg, var(--purple-deep) 0%, var(--void-lighter) 100%);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .circle-card-logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
        }

        .circle-card-name {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
        }

        .circle-card-info {
            font-size: 0.85rem;
            color: var(--white-dim);
        }

        .circle-card-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(138, 43, 226, 0.2);
        }

        .circle-stat { text-align: center; }

        .circle-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--white);
        }

        .circle-stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            letter-spacing: 0.1em;
        }

        /* Channel Config */
        .channel-config {
            background: var(--void-lighter);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .channel-config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .channel-config-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .channel-config-icon { font-size: 1.5rem; }
        .channel-config-name { font-weight: 500; }

        .channel-config-status {
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
        }

        .channel-config-status.connected {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green);
        }

        .channel-config-status.available {
            background: rgba(245, 158, 11, 0.15);
            color: var(--orange);
        }

        .channel-config-status.offline {
            background: rgba(106, 106, 122, 0.15);
            color: var(--gray);
        }

        .channel-config-desc {
            font-size: 0.8rem;
            color: var(--gray);
            line-height: 1.4;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.open { display: flex; }

        .modal-content {
            background: var(--void-light);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 20px;
            padding: 2rem;
            max-width: 360px;
            width: 100%;
            text-align: center;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .call-modal-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--purple-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--purple-light);
            margin: 1rem auto;
        }

        .call-modal-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: var(--white);
            margin-bottom: 0.5rem;
        }

        .call-modal-status {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .call-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .call-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .call-action-btn.end {
            background: var(--red);
            color: white;
        }

        .call-action-btn.accept {
            background: var(--green);
            color: white;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .welcome-title { font-size: 2rem; }
            .message { max-width: 90%; }
            .composer-actions { display: none; }
            .panel { max-width: 100%; }
        }

        @supports (padding-top: env(safe-area-inset-top)) {
            .app-header { padding-top: calc(1rem + env(safe-area-inset-top)); }
            .composer { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--void-lighter);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            color: var(--white);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast-success {
            border-color: var(--green);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .toast-error {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.15);
        }
        
        .toast-info {
            border-color: var(--purple);
            background: rgba(138, 43, 226, 0.15);
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--gray);
            animation: fadeIn 0.3s ease;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--purple-light);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-5px); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Connection status indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            color: var(--gray);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            background: var(--void);
        }
        
        .connection-status.online { color: var(--green); }
        .connection-status.offline { color: var(--red); }
        .connection-status.reconnecting { color: var(--orange); }
        
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .connection-status.online .connection-dot {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .connection-status.reconnecting .connection-dot {
            animation: blink 0.5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        /* Empty state */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.1rem;
            color: var(--white-dim);
            margin-bottom: 0.5rem;
        }
        
        .empty-state-text {
            font-size: 0.9rem;
            max-width: 280px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Ink Background -->
        <div class="ink-bg">
            <div class="ink-blob ink-blob-1"></div>
            <div class="ink-blob ink-blob-2"></div>
            <div class="ink-blob ink-blob-3"></div>
        </div>

        <!-- ==================== WELCOME SCREEN ==================== -->
        <div class="screen welcome-screen active" id="welcomeScreen">
            <!-- Vrai logo Octopus -->
            <svg class="welcome-logo" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="bodyGradient" cx="50%" cy="30%" r="60%">
                        <stop offset="0%" style="stop-color:#b366e8"/>
                        <stop offset="100%" style="stop-color:#4a0080"/>
                    </radialGradient>
                    <linearGradient id="tentGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#9b4dca"/>
                        <stop offset="50%" style="stop-color:#6a1bb2"/>
                        <stop offset="100%" style="stop-color:#3d0066"/>
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <!-- Tentacle 1 -->
                <path d="M150,200 C100,180 50,220 30,280 C10,340 50,390 120,380 C180,370 220,340 250,300 C270,270 300,250 340,260 C380,270 395,310 380,350 C365,390 320,400 280,390" fill="none" stroke="url(#tentGrad)" stroke-width="22" stroke-linecap="round" filter="url(#glow)"/>
                <path d="M150,200 C100,180 50,220 30,280 C10,340 50,390 120,380 C180,370 220,340 250,300 C270,270 300,250 340,260 C380,270 395,310 380,350 C365,390 320,400 280,390" fill="none" stroke="#2d0a4e" stroke-width="8" stroke-linecap="round" stroke-dasharray="2,15"/>
                <!-- Tentacle 2 -->
                <path d="M250,200 C300,180 350,150 370,100 C385,50 350,10 290,20 C230,30 180,60 150,100 C120,140 80,130 50,100 C20,70 10,30 30,10" fill="none" stroke="url(#tentGrad)" stroke-width="20" stroke-linecap="round" filter="url(#glow)"/>
                <path d="M250,200 C300,180 350,150 370,100 C385,50 350,10 290,20 C230,30 180,60 150,100 C120,140 80,130 50,100 C20,70 10,30 30,10" fill="none" stroke="#2d0a4e" stroke-width="6" stroke-linecap="round" stroke-dasharray="2,12"/>
                <!-- Tentacle 3 -->
                <path d="M180,220 C150,260 100,300 80,350 C60,400 100,420 160,400 C220,380 280,400 340,420 C400,440 420,400 400,350" fill="none" stroke="url(#tentGrad)" stroke-width="18" stroke-linecap="round" filter="url(#glow)"/>
                <path d="M180,220 C150,260 100,300 80,350 C60,400 100,420 160,400 C220,380 280,400 340,420 C400,440 420,400 400,350" fill="none" stroke="#2d0a4e" stroke-width="5" stroke-linecap="round" stroke-dasharray="2,10"/>
                <!-- Tentacle 4 -->
                <path d="M260,190 C310,170 360,200 380,250 C400,300 390,360 350,380 C310,400 260,380 240,340" fill="none" stroke="url(#tentGrad)" stroke-width="16" stroke-linecap="round" filter="url(#glow)"/>
                <path d="M260,190 C310,170 360,200 380,250 C400,300 390,360 350,380 C310,400 260,380 240,340" fill="none" stroke="#2d0a4e" stroke-width="5" stroke-linecap="round" stroke-dasharray="2,10"/>
                <!-- Tentacle 5 -->
                <path d="M140,190 C90,170 40,200 20,250 C0,300 10,360 50,380 C90,400 140,380 160,340" fill="none" stroke="url(#tentGrad)" stroke-width="16" stroke-linecap="round" filter="url(#glow)"/>
                <path d="M140,190 C90,170 40,200 20,250 C0,300 10,360 50,380 C90,400 140,380 160,340" fill="none" stroke="#2d0a4e" stroke-width="5" stroke-linecap="round" stroke-dasharray="2,10"/>
                <!-- Tentacle 6 -->
                <path d="M200,150 C200,100 240,60 280,40 C320,20 370,40 380,80 C390,120 360,150 320,160" fill="none" stroke="url(#tentGrad)" stroke-width="14" stroke-linecap="round" filter="url(#glow)"/>
                <!-- Tentacle 7 -->
                <path d="M180,150 C160,100 120,60 80,40 C40,20 10,50 10,90 C10,130 40,160 80,165" fill="none" stroke="url(#tentGrad)" stroke-width="14" stroke-linecap="round" filter="url(#glow)"/>
                <!-- Tentacle 8 -->
                <path d="M220,210 C250,230 280,280 260,320 C240,360 200,370 170,350" fill="none" stroke="url(#tentGrad)" stroke-width="12" stroke-linecap="round" filter="url(#glow)"/>
                <!-- Corps -->
                <ellipse cx="200" cy="180" rx="70" ry="60" fill="url(#bodyGradient)" filter="url(#glow)"/>
                <ellipse cx="200" cy="145" rx="45" ry="40" fill="url(#bodyGradient)"/>
                <!-- Yeux -->
                <ellipse cx="175" cy="175" rx="18" ry="22" fill="#0a0015"/>
                <ellipse cx="225" cy="175" rx="18" ry="22" fill="#0a0015"/>
                <ellipse cx="175" cy="175" rx="18" ry="22" fill="none" stroke="#8a2be2" stroke-width="2" opacity="0.5"/>
                <ellipse cx="225" cy="175" rx="18" ry="22" fill="none" stroke="#8a2be2" stroke-width="2" opacity="0.5"/>
                <ellipse cx="178" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                <ellipse cx="228" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                <circle cx="172" cy="168" r="4" fill="#fff" opacity="0.9"/>
                <circle cx="222" cy="168" r="4" fill="#fff" opacity="0.9"/>
                <text x="385" y="45" font-family="Arial, sans-serif" font-size="28" fill="#a855f7" font-weight="500">‚Ñ¢</text>
            </svg>
            
            <h1 class="welcome-title">OCTOPUS</h1>
            <p class="welcome-tagline">Un cercle. Pas un r√©seau.</p>
            
            <div class="welcome-options">
                <button class="btn btn-primary" onclick="showScreen('loadScreen')">
                    <span class="btn-icon">üìÇ</span>
                    Charger mon cercle
                </button>
                <button class="btn btn-secondary" onclick="showScreen('pinScreen')">
                    <span class="btn-icon">üéÆ</span>
                    Essayer la d√©mo
                </button>
            </div>
            
            <p class="welcome-note">
                Vous n'avez pas encore de cercle ?<br>
                <a href="./order.html">Commander votre cercle ‚Üí</a>
            </p>
        </div>

        <!-- ==================== LOAD SCREEN ==================== -->
        <div class="screen load-screen" id="loadScreen">
            <button class="form-back" onclick="showScreen('welcomeScreen')">‚Üê</button>
            
            <div class="load-container">
                <h2 class="load-title">Charger votre cercle</h2>
                <p class="load-subtitle">Importez le fichier re√ßu lors de votre commande</p>
                
                <div class="load-dropzone" onclick="document.getElementById('fileInput').click()">
                    <div class="load-dropzone-icon">üêô</div>
                    <p class="load-dropzone-text">Glissez votre fichier .octopus ici</p>
                    <p class="load-dropzone-hint">ou cliquez pour parcourir</p>
                    <input type="file" id="fileInput" accept=".octopus" style="display: none;" onchange="loadCircleFile(this)">
                </div>
                
                <div class="load-divider">ou</div>
                
                <button class="btn btn-secondary" style="width: 100%;" onclick="openQRScanner()">
                    <span class="btn-icon">üì∑</span>
                    Scanner le QR du cercle
                </button>
            </div>
        </div>

        <!-- ==================== PIN SCREEN (DEMO) ==================== -->
        <div class="screen pin-screen" id="pinScreen">
            <button class="form-back" onclick="showScreen('welcomeScreen')">‚Üê</button>
            
            <div class="demo-badge">MODE D√âMO</div>
            
            <h2 class="pin-title">Cercle Demo Public</h2>
            <p class="pin-subtitle">Choisissez votre personnage pour explorer OCTOPUS</p>
            
            <div class="character-grid">
                <button class="character-btn" onclick="enterDemoAs(1, 'Alice')">
                    <span class="character-avatar">üë©</span>
                    <span class="character-name">Alice</span>
                    <span class="character-number">#1</span>
                </button>
                <button class="character-btn" onclick="enterDemoAs(2, 'Bob')">
                    <span class="character-avatar">üë®</span>
                    <span class="character-name">Bob</span>
                    <span class="character-number">#2</span>
                </button>
                <button class="character-btn" onclick="enterDemoAs(3, 'Charlie')">
                    <span class="character-avatar">üßî</span>
                    <span class="character-name">Charlie</span>
                    <span class="character-number">#3</span>
                </button>
                <button class="character-btn" onclick="enterDemoAs(4, 'David')">
                    <span class="character-avatar">üë¥</span>
                    <span class="character-name">David</span>
                    <span class="character-number">#4</span>
                </button>
                <button class="character-btn" onclick="enterDemoAs(5, 'Eve')">
                    <span class="character-avatar">üëµ</span>
                    <span class="character-name">Eve</span>
                    <span class="character-number">#5</span>
                </button>
            </div>
            
            <p class="pin-hint">
                üí° Ouvrez cette page dans plusieurs navigateurs et choisissez des personnages diff√©rents pour voir la messagerie en action !
            </p>
        </div>

        <!-- ==================== MAIN APP SCREEN ==================== -->
        <div class="screen main-screen" id="mainScreen">
            <header class="app-header">
                <div class="header-left">
                    <div class="circle-avatar">
                        <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <radialGradient id="miniBody" cx="50%" cy="30%" r="60%">
                                    <stop offset="0%" style="stop-color:#b366e8"/>
                                    <stop offset="100%" style="stop-color:#4a0080"/>
                                </radialGradient>
                                <linearGradient id="miniTent" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#9b4dca"/>
                                    <stop offset="100%" style="stop-color:#3d0066"/>
                                </linearGradient>
                            </defs>
                            <path d="M150,200 C100,180 50,220 30,280 C10,340 50,390 120,380" fill="none" stroke="url(#miniTent)" stroke-width="24" stroke-linecap="round"/>
                            <path d="M250,200 C300,180 350,150 370,100" fill="none" stroke="url(#miniTent)" stroke-width="22" stroke-linecap="round"/>
                            <path d="M180,220 C150,260 100,300 80,350" fill="none" stroke="url(#miniTent)" stroke-width="20" stroke-linecap="round"/>
                            <path d="M220,210 C250,230 280,280 260,320" fill="none" stroke="url(#miniTent)" stroke-width="14" stroke-linecap="round"/>
                            <ellipse cx="200" cy="180" rx="70" ry="60" fill="url(#miniBody)"/>
                            <ellipse cx="200" cy="145" rx="45" ry="40" fill="url(#miniBody)"/>
                            <ellipse cx="175" cy="175" rx="18" ry="22" fill="#0a0015"/>
                            <ellipse cx="225" cy="175" rx="18" ry="22" fill="#0a0015"/>
                            <ellipse cx="178" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                            <ellipse cx="228" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                        </svg>
                    </div>
                    <div class="circle-info">
                        <h1 id="circleNameDisplay">Cercle D√©mo</h1>
                        <p class="circle-members">
                            <span id="memberCount">4</span> membres ‚Ä¢ 
                            <span class="my-number">Vous √™tes #<span id="myNumber">2</span></span>
                        </p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="connection-status online">
                        <span class="connection-dot"></span>
                        <span>Connect√©</span>
                    </div>
                    <button class="header-btn" onclick="openPanel('channelsPanel')">üì°</button>
                    <button class="header-btn" onclick="openPanel('membersPanel')">üë•</button>
                    <button class="header-btn" onclick="openPanel('settingsPanel')">‚öôÔ∏è</button>
                </div>
            </header>

            <div class="channel-bar">
                <div class="channel-item active">
                    <span class="channel-dot"></span>
                    <span>Internet</span>
                </div>
                <div class="channel-item available">
                    <span class="channel-dot"></span>
                    <span>Bluetooth</span>
                </div>
                <div class="channel-item offline">
                    <span class="channel-dot"></span>
                    <span>QR Code</span>
                </div>
                <div class="channel-item offline">
                    <span class="channel-dot"></span>
                    <span>USB</span>
                </div>
                <div class="channel-item offline">
                    <span class="channel-dot"></span>
                    <span>Radio</span>
                </div>
            </div>

            <div class="messages-area" id="messagesArea"></div>

            <div class="composer">
                <!-- Recipient Selector -->
                <div class="recipient-bar">
                    <span class="recipient-label">√Ä :</span>
                    <div class="recipient-selector" id="recipientSelector">
                        <div class="recipient-chip all selected" data-recipient="all" onclick="selectRecipient('all')">
                            <span class="chip-icon">üë•</span>
                            <span>Tout le cercle</span>
                        </div>
                        <!-- Les membres seront ajout√©s dynamiquement -->
                    </div>
                </div>
                
                <div class="composer-container">
                    <div class="composer-actions">
                        <button class="composer-btn" onclick="openQRModal()">üì∑</button>
                        <button class="composer-btn">üìé</button>
                    </div>
                    <div class="composer-input-wrapper">
                        <textarea class="composer-input" id="messageInput" placeholder="√âcrire un message..." rows="1"></textarea>
                    </div>
                    <button class="composer-send" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- ==================== MEMBERS PANEL ==================== -->
        <div class="panel" id="membersPanel">
            <div class="panel-header">
                <h2 class="panel-title">Membres</h2>
                <button class="panel-close" onclick="closePanel()">√ó</button>
            </div>
            <div class="panel-content">
                <div class="search-container">
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="memberSearch" placeholder="Num√©ro ou nom (#3, Alice...)" oninput="filterMembers(this.value)">
                    </div>
                </div>
                <div id="membersList"></div>
            </div>
        </div>

        <!-- ==================== CHANNELS PANEL ==================== -->
        <div class="panel" id="channelsPanel">
            <div class="panel-header">
                <h2 class="panel-title">Canaux</h2>
                <button class="panel-close" onclick="closePanel()">√ó</button>
            </div>
            <div class="panel-content">
                <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 1.5rem;">
                    OCTOPUS utilise tous les canaux disponibles. M√™me sans Internet.
                </p>
                
                <div class="channel-config">
                    <div class="channel-config-header">
                        <div class="channel-config-left">
                            <span class="channel-config-icon">üåê</span>
                            <span class="channel-config-name">Internet</span>
                        </div>
                        <span class="channel-config-status connected">Connect√©</span>
                    </div>
                    <p class="channel-config-desc">Relais chiffr√©. Latence ~100ms.</p>
                </div>
                
                <div class="channel-config">
                    <div class="channel-config-header">
                        <div class="channel-config-left">
                            <span class="channel-config-icon">üì∂</span>
                            <span class="channel-config-name">Bluetooth</span>
                        </div>
                        <span class="channel-config-status available">Disponible</span>
                    </div>
                    <p class="channel-config-desc">Sync directe (~10m). Aucun serveur.</p>
                </div>
                
                <div class="channel-config">
                    <div class="channel-config-header">
                        <div class="channel-config-left">
                            <span class="channel-config-icon">üì∑</span>
                            <span class="channel-config-name">QR Code</span>
                        </div>
                        <span class="channel-config-status offline">Manuel</span>
                    </div>
                    <p class="channel-config-desc">Capsules par scan. Zone blanche.</p>
                </div>
                
                <div class="channel-config">
                    <div class="channel-config-header">
                        <div class="channel-config-left">
                            <span class="channel-config-icon">üîå</span>
                            <span class="channel-config-name">USB / Fichier</span>
                        </div>
                        <span class="channel-config-status offline">Manuel</span>
                    </div>
                    <p class="channel-config-desc">Export/import via cl√© USB.</p>
                </div>
                
                <div class="channel-config">
                    <div class="channel-config-header">
                        <div class="channel-config-left">
                            <span class="channel-config-icon">üìª</span>
                            <span class="channel-config-name">Radio / LoRa</span>
                        </div>
                        <span class="channel-config-status offline">Non configur√©</span>
                    </div>
                    <p class="channel-config-desc">Longue port√©e via SDR ou LoRa.</p>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS PANEL ==================== -->
        <div class="panel" id="settingsPanel">
            <div class="panel-header">
                <h2 class="panel-title">Param√®tres</h2>
                <button class="panel-close" onclick="closePanel()">√ó</button>
            </div>
            <div class="panel-content">
                <div class="circle-card">
                    <svg class="circle-card-logo" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <radialGradient id="cardBody" cx="50%" cy="30%" r="60%">
                                <stop offset="0%" style="stop-color:#b366e8"/>
                                <stop offset="100%" style="stop-color:#4a0080"/>
                            </radialGradient>
                            <linearGradient id="cardTent" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#9b4dca"/>
                                <stop offset="100%" style="stop-color:#3d0066"/>
                            </linearGradient>
                        </defs>
                        <path d="M150,200 C100,180 50,220 30,280 C10,340 50,390 120,380" fill="none" stroke="url(#cardTent)" stroke-width="24" stroke-linecap="round"/>
                        <path d="M250,200 C300,180 350,150 370,100" fill="none" stroke="url(#cardTent)" stroke-width="22" stroke-linecap="round"/>
                        <path d="M180,220 C150,260 100,300 80,350" fill="none" stroke="url(#cardTent)" stroke-width="20" stroke-linecap="round"/>
                        <path d="M220,210 C250,230 280,280 260,320" fill="none" stroke="url(#cardTent)" stroke-width="14" stroke-linecap="round"/>
                        <ellipse cx="200" cy="180" rx="70" ry="60" fill="url(#cardBody)"/>
                        <ellipse cx="200" cy="145" rx="45" ry="40" fill="url(#cardBody)"/>
                        <ellipse cx="175" cy="175" rx="18" ry="22" fill="#0a0015"/>
                        <ellipse cx="225" cy="175" rx="18" ry="22" fill="#0a0015"/>
                        <ellipse cx="178" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                        <ellipse cx="228" cy="172" rx="7" ry="9" fill="#bf5fff"/>
                    </svg>
                    <h3 class="circle-card-name" id="settingsCircleName">Cercle D√©mo</h3>
                    <p class="circle-card-info">Vous √™tes le membre #<span id="settingsMyNumber">2</span></p>
                    <div class="circle-card-stats">
                        <div class="circle-stat">
                            <div class="circle-stat-value" id="settingsMemberCount">4</div>
                            <div class="circle-stat-label">MEMBRES</div>
                        </div>
                        <div class="circle-stat">
                            <div class="circle-stat-value" id="settingsMessageCount">12</div>
                            <div class="circle-stat-label">MESSAGES</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">NOTIFICATIONS</h3>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <span class="settings-icon">üîî</span>
                            <span class="settings-label">Notifications push</span>
                        </div>
                        <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <span class="settings-icon">üîä</span>
                            <span class="settings-label">Sons</span>
                        </div>
                        <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">S√âCURIT√â</h3>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <span class="settings-icon">üîê</span>
                            <span class="settings-label">Chiffrement</span>
                        </div>
                        <span class="settings-value" style="color: var(--green);">ASEMANTIX</span>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <span class="settings-icon">üõ°Ô∏è</span>
                            <span class="settings-label">Mode COMPLIANT</span>
                        </div>
                        <div class="toggle" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">ZONE DE DANGER</h3>
                    <button class="btn btn-secondary" style="width: 100%; color: var(--red); border-color: rgba(239, 68, 68, 0.3); margin-bottom: 0.75rem;" onclick="clearLocalData()">
                        üóëÔ∏è Effacer les donn√©es locales
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="closePanel(); logout()">
                        üö™ Quitter le cercle
                    </button>
                </div>
                
                <div class="settings-section" style="margin-top: 2rem; text-align: center;">
                    <p style="font-size: 0.75rem; color: var(--gray);">
                        OCTOPUS v1.0.0<br>
                        Par <a href="https://asemantix.tech" target="_blank" style="color: var(--gold);">ASEMANTIX‚Ñ¢</a>
                    </p>
                </div>
            </div>
        </div>

        <div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>

        <!-- ==================== CALL MODAL ==================== -->
        <div class="modal" id="callModal">
            <div class="modal-content">
                <h3 class="modal-title">Appel en cours</h3>
                <div class="call-modal-avatar" id="callAvatar">#3</div>
                <p class="call-modal-number" id="callNumber">Membre #3</p>
                <p class="call-modal-status">Connexion via Internet...</p>
                <div class="call-actions">
                    <button class="call-action-btn end" onclick="closeModal()">üìû</button>
                </div>
            </div>
        </div>

        <!-- ==================== QR MODAL ==================== -->
        <div class="modal" id="qrModal">
            <div class="modal-content">
                <h3 class="modal-title">Capsule QR</h3>
                <p style="color: var(--gray); font-size: 0.9rem;">Capsule chiffr√©e avec vos derniers messages</p>
                <div style="width: 180px; height: 180px; background: var(--white); border-radius: 12px; margin: 1.5rem auto; display: flex; align-items: center; justify-content: center; color: var(--void);">
                    [QR Capsule]
                </div>
                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Fermer</button>
                    <button class="btn btn-primary" style="flex: 1;">üì∑ Scanner</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        const state = {
            myNumber: 1,
            myName: 'Alice',
            circle: { name: 'Cercle Demo Public', members: 5, domain: 'cercle-demo-public-pfbz', id: 'f42517e440048f5b' },
            members: [
                { number: 1, name: 'Alice', online: true },
                { number: 2, name: 'Bob', online: true },
                { number: 3, name: 'Charlie', online: false },
                { number: 4, name: 'David', online: false },
                { number: 5, name: 'Eve', online: true }
            ],
            messages: [],
            selectedRecipient: 'all', // 'all' ou num√©ro du membre
            activeChannel: 'internet',
            connected: true,
            typingMembers: [], // Membres en train de taper
            unreadCount: 0
        };

        const demoMessages = [
            { id: 1, from: 1, text: "Salut le cercle ! Le nouveau protocole est d√©ploy√© üöÄ", time: "10:30", channel: "internet", to: "all", status: "read" },
            { id: 2, from: 2, text: "Excellent ! J'ai test√© la sync Bluetooth, √ßa marche parfaitement.", time: "10:32", channel: "bluetooth", to: "all", status: "read" },
            { id: 3, from: 3, text: "On peut communiquer m√™me en zone blanche totale.", time: "10:33", channel: "internet", to: "all", status: "read" },
            { id: 4, from: 5, text: "J'ai re√ßu vos messages via le QR de Bob. Impressionnant ! üì±", time: "10:45", channel: "qr", to: "all", status: "read" },
            { id: 5, from: 4, text: "La pieuvre est vraiment r√©volutionnaire !", time: "11:02", channel: "internet", to: "all", status: "read" },
        ];

        // ==================== SCREENS ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // ==================== DEMO ====================
        function enterDemoAs(num, name) {
            state.myNumber = num;
            state.myName = name;
            state.messages = [...demoMessages]; // Copie des messages d√©mo
            
            // Update le nom du membre actuel dans la liste
            state.members = state.members.map(m => 
                m.number === num ? { ...m, name: 'Moi (' + name + ')', online: true } : m
            );
            
            // Update UI
            document.getElementById('myNumber').textContent = num;
            document.getElementById('settingsMyNumber').textContent = num;
            document.getElementById('circleNameDisplay').textContent = state.circle.name;
            document.getElementById('memberCount').textContent = state.circle.members;
            
            renderMembers();
            renderMessages();
            showScreen('mainScreen');
            
            showToast(`Bienvenue ${name} ! Vous √™tes #${num}`, 'success');
            
              // Tenter la connexion au relais pour synchronisation r√©elle
connectToDemoRelay(num);
        }
        
        // Ancienne fonction pour compatibilit√©
        function enterDemo() {
            const input = document.getElementById('memberNumber');
            const num = parseInt(input?.value) || 1;
            const names = ['Alice', 'Bob', 'Charlie', 'David', 'Eve'];
            enterDemoAs(num, names[num - 1] || 'Membre');
        }
        async function connectToDemoRelay(memberNumber) {
    try {
        const response = await fetch(`${API_URL}/api/demo/token/${memberNumber}`);
        const result = await response.json();
        
        if (!result.success || !result.token) {
            throw new Error(result.error || '√âchec authentification d√©mo');
        }
        
        state.token = result.token;
        connectWebSocket();
        await fetchMessages();
        showToast('Connect√© au relais !', 'success');
    } catch (err) {
        console.log('Mode d√©mo local:', err.message);
        startDemoSimulation();
    }
}
        function startDemoSimulation() {
            // Simuler un membre qui tape apr√®s 5 secondes
            setTimeout(() => {
                if (state.myNumber !== 1) {
                    showTypingIndicator(1);
                    
                    setTimeout(() => {
                        hideTypingIndicator(1);
                        receiveMessage({
                            from: 1,
                            text: "Content de te voir en ligne ! üëã",
                            to: state.myNumber,
                            private: true,
                            channel: 'internet'
                        });
                    }, 2000);
                }
            }, 5000);
            
            // Simuler un message broadcast apr√®s 15 secondes
            setTimeout(() => {
                const otherMember = state.members.find(m => m.number !== state.myNumber && m.online);
                if (otherMember) {
                    showTypingIndicator(otherMember.number);
                    
                    setTimeout(() => {
                        hideTypingIndicator(otherMember.number);
                        receiveMessage({
                            from: otherMember.number,
                            text: "Quelqu'un a test√© le canal QR code ?",
                            to: 'all',
                            channel: 'internet'
                        });
                    }, 1500);
                }
            }, 15000);
        }
        
        function showTypingIndicator(memberNumber) {
            if (!state.typingMembers.includes(memberNumber)) {
                state.typingMembers.push(memberNumber);
                updateTypingIndicator();
            }
        }
        
        function hideTypingIndicator(memberNumber) {
            state.typingMembers = state.typingMembers.filter(n => n !== memberNumber);
            updateTypingIndicator();
        }
        
        function updateTypingIndicator() {
            const area = document.getElementById('messagesArea');
            const existingIndicator = document.querySelector('.typing-indicator');
            
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            if (state.typingMembers.length > 0) {
                const names = state.typingMembers.map(n => {
                    const member = state.members.find(m => m.number === n);
                    return member ? member.name : `#${n}`;
                });
                
                const text = names.length === 1 
                    ? `${names[0]} √©crit...`
                    : `${names.join(', ')} √©crivent...`;
                
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.innerHTML = `
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>${text}</span>
                `;
                area.appendChild(indicator);
                area.scrollTop = area.scrollHeight;
            }
        }
        
        function receiveMessage(msgData) {
            const newMessage = {
                id: Date.now(),
                from: msgData.from,
                to: msgData.to || 'all',
                text: msgData.text,
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                channel: msgData.channel || 'internet',
                private: msgData.private || false,
                status: 'received'
            };
            
            state.messages.push(newMessage);
            renderMessages();
            
            // Son de notification (optionnel)
            // playNotificationSound();
            
            // Toast pour les messages priv√©s
            if (newMessage.private && newMessage.to === state.myNumber) {
                const sender = state.members.find(m => m.number === newMessage.from);
                showToast(`Message priv√© de ${sender ? sender.name : '#' + newMessage.from}`, 'info');
            }
        }

        function loadCircleFile(input) {
            if (input.files.length > 0) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Valider la structure du fichier .octopus
                        if (!data.circle || !data.member || !data.version) {
                            throw new Error('Format de fichier invalide');
                        }
                        
                        // Charger les donn√©es du cercle
                        state.circle = {
                            name: data.circle.name,
                            members: data.circle.members,
                            domain: data.circle.domain || data.circle.id
                        };
                        state.myNumber = data.member.number;
                        
                        // G√©n√©rer les membres (dans une vraie app, on les r√©cup√®rerait du serveur)
                        state.members = [];
                        for (let i = 1; i <= data.circle.members; i++) {
                            state.members.push({
                                number: i,
                                name: i === data.member.number ? (data.member.name || 'Moi') : `Membre ${i}`,
                                online: i === data.member.number // Par d√©faut, seul moi est en ligne
                            });
                        }
                        
                        // Stocker les cl√©s (dans une vraie app, on les utiliserait pour le chiffrement)
                        state.keys = data.member.keys;
                        state.seed = data.member.seed;
                        
                        // Mettre √† jour l'UI
                        document.getElementById('circleNameDisplay').textContent = state.circle.name;
                        document.getElementById('memberCount').textContent = state.circle.members;
                        document.getElementById('myNumber').textContent = state.myNumber;
                        document.getElementById('settingsMyNumber').textContent = state.myNumber;
                        document.getElementById('settingsCircleName').textContent = state.circle.name;
                        document.getElementById('settingsMemberCount').textContent = state.circle.members;
                        
                        // Initialiser
                        state.messages = [];
                        renderMembers();
                        renderMessages();
                        showScreen('mainScreen');
                        
                        showToast(`Cercle "${state.circle.name}" charg√© avec succ√®s !`, 'success');
                        
                        // Connecter au relais (dans une vraie app)
                        // connectToRelay(data);
                        
                    } catch (err) {
                        showToast('Erreur: ' + err.message, 'error');
                        console.error('Erreur chargement fichier:', err);
                    }
                };
                
                reader.onerror = function() {
                    showToast('Erreur de lecture du fichier', 'error');
                };
                
                reader.readAsText(file);
            }
        }

        function openQRScanner() {
            // Dans une vraie app, on utiliserait l'API MediaDevices pour acc√©der √† la cam√©ra
            showToast('Scanner QR : Fonctionnalit√© disponible dans l\'app native', 'info');
        }
        
        function logout() {
            // Fermer la connexion WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // R√©initialiser l'√©tat
            state.messages = [];
            state.members = [
                { number: 1, name: 'Alice', online: true },
                { number: 2, name: 'Moi', online: true },
                { number: 3, name: 'Bob', online: true },
                { number: 4, name: 'Charlie', online: false }
            ];
            state.token = null;
            state.keys = null;
            state.seed = null;
            state.selectedRecipient = 'all';
            state.typingMembers = [];
            
            // Retourner √† l'√©cran d'accueil
            showScreen('welcomeScreen');
            showToast('D√©connect√© du cercle', 'info');
        }
        
        function exportQRCapsule() {
            // G√©n√®re un QR code avec les derniers messages chiffr√©s
            // Pour la transmission hors-ligne (canal QR)
            const recentMessages = state.messages.slice(-5);
            const capsule = {
                type: 'octopus-capsule',
                circle: state.circle.domain,
                from: state.myNumber,
                messages: recentMessages.map(m => ({
                    from: m.from,
                    text: encryptPayload(m.text),
                    time: m.time
                })),
                timestamp: Date.now()
            };
            
            // Dans une vraie app, on g√©n√©rerait un vrai QR code
            console.log('Capsule QR:', capsule);
            showToast('Capsule QR g√©n√©r√©e', 'success');
        }
        
        function clearLocalData() {
            if (confirm('Voulez-vous vraiment effacer toutes les donn√©es locales ? Cette action est irr√©versible.')) {
                // Effacer les messages
                state.messages = [];
                renderMessages();
                
                // Effacer le localStorage si utilis√©
                try {
                    localStorage.removeItem('octopus_data');
                    localStorage.removeItem('octopus_token');
                } catch (e) {
                    console.log('localStorage non disponible');
                }
                
                showToast('Donn√©es locales effac√©es', 'success');
            }
        }

        // ==================== MEMBERS ====================
        function renderMembers() {
            const list = document.getElementById('membersList');
            list.innerHTML = state.members.map(m => {
                const isMe = m.number === state.myNumber;
                return `
                    <div class="member-item" onclick="${isMe ? '' : `callMember(${m.number})`}">
                        <div class="member-avatar ${m.online ? 'online' : ''} ${isMe ? 'me' : ''}">#${m.number}</div>
                        <div class="member-info">
                            <div class="member-number">#${m.number} <span>${m.name}${isMe ? ' (vous)' : ''}</span></div>
                            <div class="member-status">${m.online ? 'En ligne' : 'Hors ligne'}</div>
                        </div>
                        ${!isMe ? `<button class="call-btn" onclick="event.stopPropagation(); callMember(${m.number})">üìû</button>` : ''}
                    </div>
                `;
            }).join('');
            
            // Update recipient selector
            renderRecipientSelector();
        }

        function renderRecipientSelector() {
            const selector = document.getElementById('recipientSelector');
            const otherMembers = state.members.filter(m => m.number !== state.myNumber);
            
            selector.innerHTML = `
                <div class="recipient-chip all ${state.selectedRecipient === 'all' ? 'selected' : ''}" 
                     data-recipient="all" onclick="selectRecipient('all')">
                    <span class="chip-icon">üë•</span>
                    <span>Tout le cercle</span>
                </div>
                ${otherMembers.map(m => `
                    <div class="recipient-chip ${state.selectedRecipient === m.number ? 'selected' : ''}" 
                         data-recipient="${m.number}" onclick="selectRecipient(${m.number})">
                        <span class="chip-number">#${m.number}</span>
                        <span>${m.name}</span>
                        <span class="chip-icon">${m.online ? 'üü¢' : '‚ö´'}</span>
                    </div>
                `).join('')}
            `;
        }

        function selectRecipient(recipient) {
            state.selectedRecipient = recipient;
            renderRecipientSelector();
            
            // Update placeholder
            const input = document.getElementById('messageInput');
            if (recipient === 'all') {
                input.placeholder = 'Message √† tout le cercle...';
            } else {
                const member = state.members.find(m => m.number === recipient);
                input.placeholder = `Message priv√© √† ${member.name}...`;
            }
        }

        function filterMembers(query) {
            const items = document.querySelectorAll('.member-item');
            query = query.toLowerCase().replace('#', '');
            
            items.forEach((item, index) => {
                const member = state.members[index];
                const matches = 
                    member.number.toString().includes(query) ||
                    member.name.toLowerCase().includes(query);
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function callMember(number) {
            document.getElementById('callAvatar').textContent = `#${number}`;
            document.getElementById('callNumber').textContent = `Membre #${number}`;
            document.getElementById('callModal').classList.add('open');
        }

        // ==================== MESSAGES ====================
        function renderMessages() {
            const area = document.getElementById('messagesArea');
            let html = `<div class="date-separator"><span>AUJOURD'HUI</span></div>`;
            
            // FILTRER les messages visibles pour l'utilisateur actuel
            const visibleMessages = state.messages.filter(m => {
                // Messages broadcast (to = 'all' ou non d√©fini) ‚Üí tout le monde voit
                if (!m.to || m.to === 'all') return true;
                // Messages que j'ai envoy√©s ‚Üí je vois
                if (m.from === state.myNumber) return true;
                // Messages priv√©s pour moi ‚Üí je vois
                if (m.to === state.myNumber) return true;
                // Sinon ‚Üí je ne vois pas (message priv√© entre autres)
                return false;
            });
            
            html += visibleMessages.map(m => {
                const isSent = m.from === state.myNumber;
                const isPrivate = m.private || (m.to && m.to !== 'all');
                const channelIcon = { internet: 'üåê', bluetooth: 'üì∂', qr: 'üì∑', usb: 'üîå', radio: 'üìª' }[m.channel] || 'üåê';
                
                // Pour les messages priv√©s, trouver le nom du destinataire ou exp√©diteur
                let privateLabel = '';
                if (isPrivate) {
                    if (isSent) {
                        const recipient = state.members.find(member => member.number === m.to);
                        privateLabel = `<span class="private-badge">üîí ‚Üí ${recipient ? recipient.name : '#' + m.to}</span>`;
                    } else {
                        const sender = state.members.find(member => member.number === m.from);
                        privateLabel = `<span class="private-badge">üîí De ${sender ? sender.name : '#' + m.from}</span>`;
                    }
                }
                
                // Trouver le nom de l'exp√©diteur
                const sender = state.members.find(member => member.number === m.from);
                const senderName = sender ? sender.name : `#${m.from}`;
                
                return `
                    <div class="message ${isSent ? 'sent' : ''} ${isPrivate ? 'private' : ''}">
                        <div class="message-avatar">#${m.from}</div>
                        <div class="message-content">
                            ${!isSent ? `<span class="message-sender">#${m.from} ${senderName}</span>` : ''}
                            <div class="message-bubble">
                                <p class="message-text">${escapeHtml(m.text)}</p>
                            </div>
                            <div class="message-meta">
                                ${privateLabel}
                                <span>${m.time}</span>
                                ${isSent ? '<span class="message-status">‚úì‚úì</span>' : ''}
                                <span class="message-channel">${channelIcon} ${m.channel}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            area.innerHTML = html;
            area.scrollTop = area.scrollHeight;
            document.getElementById('settingsMessageCount').textContent = visibleMessages.length;
        }
        
        // Fonction utilitaire pour √©chapper le HTML (s√©curit√©)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            // Limite de caract√®res
            if (text.length > 5000) {
                showToast('Message trop long (max 5000 caract√®res)', 'error');
                return;
            }
            
            const recipient = state.selectedRecipient;
            const isPrivate = recipient !== 'all';
            
            const newMessage = {
                id: Date.now(),
                from: state.myNumber,
                to: recipient,
                text: text,
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                channel: state.activeChannel || 'internet',
                private: isPrivate,
                status: 'sent'
            };
            
            state.messages.push(newMessage);
            
            input.value = '';
            input.style.height = 'auto';
            renderMessages();
            
            // Feedback visuel
            if (isPrivate) {
                const member = state.members.find(m => m.number === recipient);
                showToast(`Message priv√© envoy√© √† ${member ? member.name : '#' + recipient}`, 'success');
            }
            
            // Simuler l'envoi au serveur (dans la vraie app, ce serait une requ√™te API)
            // Envoyer au serveur si connect√©
if (state.token && ws && ws.readyState === WebSocket.OPEN) {
    sendMessageToServer(newMessage);
} else {
    // Mode local - simuler
    setTimeout(() => {
        const msg = state.messages.find(m => m.id === newMessage.id);
        if (msg) {
            msg.status = 'delivered';
            renderMessages();
        }
    }, 500);
}
        
        // Toast notifications
        function showToast(message, type = 'info') {
            // Supprimer les toasts existants
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            
            // Afficher
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Masquer apr√®s 3s
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== PANELS & MODALS ====================
        function openPanel(panelId) {
            closePanel();
            document.getElementById(panelId).classList.add('open');
            document.getElementById('panelOverlay').classList.add('open');
        }

        function closePanel() {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
            document.getElementById('panelOverlay').classList.remove('open');
        }

        function openQRModal() {
            document.getElementById('qrModal').classList.add('open');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
        }

        // ==================== INPUT HANDLING ====================
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('messageInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            const memberInput = document.getElementById('memberNumber');
            if (memberInput) {
                memberInput.addEventListener('input', function() {
                    this.value = this.value.replace(/\D/g, '').slice(0, 1);
                });
                memberInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') enterDemo();
                });
            }
            
            // Drag & Drop pour le fichier .octopus
            const dropzone = document.querySelector('.load-dropzone');
            if (dropzone) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => {
                        dropzone.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => {
                        dropzone.classList.remove('drag-over');
                    }, false);
                });
                
                dropzone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('fileInput');
                        fileInput.files = files;
                        loadCircleFile(fileInput);
                    }
                }, false);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closePanel(); closeModal(); }
        });
        
        // ==================== API & WEBSOCKET ====================
        const API_URL = 'https://octopus-backend-production.up.railway.app';
        const WS_URL = 'wss://octopus-backend-production.up.railway.app/ws';
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        async function connectToRelay(octopusData) {
            try {
                // Authentification
                const authResponse = await fetch(`${API_URL}/api/circles/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ octopusData })
                });
                
                const authResult = await authResponse.json();
                
                if (!authResult.success || !authResult.token) {
                    throw new Error(authResult.error || '√âchec authentification');
                }
                
                state.token = authResult.token;
                
                // Connexion WebSocket
                connectWebSocket();
                
                // Charger les messages existants
                await fetchMessages();
                
                // Charger les membres en ligne
                await fetchMembers();
                
            } catch (err) {
                console.error('Erreur connexion relais:', err);
                showToast('Connexion au relais √©chou√©e', 'error');
                updateConnectionStatus('offline');
            }
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            
            updateConnectionStatus('reconnecting');
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connect√©');
                reconnectAttempts = 0;
                
                // Authentifier
                ws.send(JSON.stringify({ type: 'auth', token: state.token }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = () => {
                console.log('WebSocket d√©connect√©');
                updateConnectionStatus('offline');
                
                // Reconnexion automatique
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };
            
            ws.onerror = (err) => {
                console.error('WebSocket erreur:', err);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'auth_success':
                    updateConnectionStatus('online');
                    break;
                    
                case 'message':
                    receiveMessage({
                        from: data.data.fromNumber,
                        text: decryptPayload(data.data.payload),
                        to: data.data.to || 'all',
                        channel: data.data.channel || 'internet',
                        private: data.data.private
                    });
                    break;
                    
                case 'member_online':
                    updateMemberStatus(data.memberNumber, true);
                    break;
                    
                case 'member_offline':
                    updateMemberStatus(data.memberNumber, false);
                    break;
                    
                case 'typing':
                    showTypingIndicator(data.memberNumber);
                    setTimeout(() => hideTypingIndicator(data.memberNumber), 3000);
                    break;
            }
        }
        
        function updateMemberStatus(memberNumber, online) {
            state.members = state.members.map(m => 
                m.number === memberNumber ? { ...m, online } : m
            );
            renderMembers();
        }
        
        function updateConnectionStatus(status) {
            state.connected = status === 'online';
            
            const statusEl = document.querySelector('.connection-status');
            if (statusEl) {
                statusEl.className = `connection-status ${status}`;
                const text = { online: 'Connect√©', offline: 'Hors ligne', reconnecting: 'Reconnexion...' }[status];
                statusEl.innerHTML = `<span class="connection-dot"></span><span>${text}</span>`;
            }
        }
        
        async function fetchMessages() {
            try {
                const response = await fetch(`${API_URL}/api/messages`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();
                
                if (data.messages) {
                    state.messages = data.messages.map(m => ({
                        id: m.id,
                        from: m.fromNumber,
                        to: m.to || 'all',
                        text: decryptPayload(m.payload),
                        time: new Date(m.createdAt).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                        channel: m.channel || 'internet',
                        private: m.private,
                        status: 'read'
                    }));
                    renderMessages();
                }
            } catch (err) {
                console.error('Erreur chargement messages:', err);
            }
        }
        
        async function fetchMembers() {
            try {
                const response = await fetch(`${API_URL}/api/circles/me`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();
                
                if (data.members) {
                    state.members = data.members.map(m => ({
                        number: m.number,
                        name: m.isMe ? 'Moi' : `Membre ${m.number}`,
                        online: m.online
                    }));
                    renderMembers();
                }
            } catch (err) {
                console.error('Erreur chargement membres:', err);
            }
        }
        
        async function sendMessageToServer(message) {
            if (!state.token) return false;
            
            try {
                const response = await fetch(`${API_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({
                        payload: encryptPayload(message.text),
                        to: message.to,
                        private: message.private
                    })
                });
                
                return response.ok;
            } catch (err) {
                console.error('Erreur envoi message:', err);
                return false;
            }
        }
        
        // Chiffrement/d√©chiffrement simplifi√© (√† remplacer par vrai chiffrement avec les cl√©s)
        function encryptPayload(text) {
            return btoa(unescape(encodeURIComponent(text)));
        }
        
        function decryptPayload(payload) {
            try {
                return decodeURIComponent(escape(atob(payload)));
            } catch {
                return payload;
            }
        }
        
        // Ping p√©riodique pour maintenir la connexion
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
    </script>
</body>
</html>
